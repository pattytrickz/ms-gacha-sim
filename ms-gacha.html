<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MapleStory: Idle RPG - Weapon Gacha Simulator</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      padding: 20px;
    }
    h1 {
      color: #facc15;
      margin-bottom: 8px;
    }
    h2 {
      margin-top: 0;
    }
    .card {
      background: #0f172a;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    label {
      display: block;
      margin-top: 8px;
      font-size: 0.9rem;
    }
    input {
      margin-top: 4px;
      padding: 6px 8px;
      border-radius: 4px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      width: 100%;
      box-sizing: border-box;
    }
    button {
      margin-right: 8px;
      margin-top: 10px;
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-weight: 600;
    }
    button.primary {
      background: #2563eb;
      color: white;
    }
    button.secondary {
      background: #4b5563;
      color: white;
    }
    button.danger {
      background: #b91c1c;
      color: white;
    }
    pre {
      background: #020617;
      padding: 10px;
      border-radius: 6px;
      max-height: 260px;
      overflow-y: auto;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
    .stat-label {
      color: #9ca3af;
    }

    /* Rarity text colors */
    .rarity-normal { color: #9ca3af; }     /* Grey */
    .rarity-rare { color: #3b82f6; }       /* Blue */
    .rarity-epic { color: #a855f7; }       /* Purple */
    .rarity-unique { color: #f97316; }     /* Orange */
    .rarity-legendary { color: #22c55e; }  /* Green */
    .rarity-mystic { color: #ef4444; }     /* Red */
    .rarity-ancient {
      color: #ec4899;                      /* Pink */
      font-weight: bold;
      text-shadow: 0 0 6px rgba(236, 72, 153, 0.8);
    }
  </style>
</head>
<body>
  <h1>Maple-Style Gacha Simulator</h1>
  <p class="stat-label">
    Rates: Normal 39.387%, Rare 39.387%, Epic 7.1%, Unique 3.3%, Legendary 0.4%, Mystic 0.11%, Ancient 0.003%
  </p>

  <div class="card">
    <h2>Roll Settings</h2>
    <label>
      Number of pulls (this action):
      <input id="pullsInput" type="number" min="0" max="3000" value="10">
    </label>
    <small class="stat-label">
      20 gems per pull · $1.50 = 1500 gems · Ancient = 0.003% (T4 only)
    </small>
    <div>
      <button class="primary" id="runBtn">Run Pulls</button>
      <button class="secondary" id="rerollBtn">Reroll Same</button>
      <button class="danger" id="resetBtn">Reset Session</button>
    </div>
  </div>

  <div class="card">
    <h2>Session Stats</h2>
    <div><span class="stat-label">Total pulls:</span> <span id="totalPulls">0</span></div>
    <div><span class="stat-label">Total Ancient hits:</span> <span id="totalAncient">0</span></div>
    <div><span class="stat-label">Pulls since last Ancient:</span> <span id="sinceAncient">0</span></div>
    <div><span class="stat-label">Total gems spent (20 per pull):</span> <span id="totalGems">0</span></div>
    <div><span class="stat-label">Approx money ($1.50 = 1500 gems):</span> <span id="totalMoney">0.00</span> CAD</div>
  </div>

  <div class="card">
    <h2>Last Action Result</h2>
    <pre id="log"></pre>
  </div>

  <div class="card">
    <h2>Session Report & Percentiles</h2>
    <pre id="sessionReport"></pre>
  </div>

  <script>
    // --- ECONOMY CONFIG ---
    const GEMS_PER_PULL = 20;
    const GEMS_PER_PACK = 1500;
    const DOLLARS_PER_PACK = 1.50;
    const DOLLAR_PER_GEM = DOLLARS_PER_PACK / GEMS_PER_PACK; // 0.001 CAD

    // Ancient theoretical rate for percentiles (fixed at 0.003% as per your example)
    const ANCIENT_RATE_PERCENT = 0.003;
    const ANCIENT_P = ANCIENT_RATE_PERCENT / 100.0; // 0.00003

    // --- RARITY & TIER TABLE ---
    const RARITIES = [
      {
        key: "normal",
        name: "Normal",
        prob: 39.387,
        tiers: { T4: 40, T3: 30, T2: 20, T1: 10 }
      },
      {
        key: "rare",
        name: "Rare",
        prob: 39.387,
        tiers: { T4: 40, T3: 30, T2: 20, T1: 10 }
      },
      {
        key: "epic",
        name: "Epic",
        prob: 7.1,
        tiers: { T4: 40, T3: 30, T2: 20, T1: 10 }
      },
      {
        key: "unique",
        name: "Unique",
        prob: 3.3,
        tiers: { T4: 40, T3: 30, T2: 20, T1: 10 }
      },
      {
        key: "legendary",
        name: "Legendary",
        prob: 0.4,
        tiers: { T4: 40, T3: 33, T2: 20, T1: 7 }
      },
      {
        key: "mystic",
        name: "Mystic",
        prob: 0.11,
        tiers: { T4: 50, T3: 30, T2: 13, T1: 7 }
      },
      {
        key: "ancient",
        name: "Ancient",
        prob: 0.003,
        tiers: { T4: 100 } // Always T4
      }
    ];

    const TOTAL_RARITY_WEIGHT = RARITIES.reduce((sum, r) => sum + r.prob, 0);

    // --- SESSION STATE ---
    let totalPulls = 0;
    let totalGems = 0;
    let totalAncientHits = 0;
    let pullsSinceLastAncient = 0;

    const sessionRarityCounts = {};
    const sessionTierCounts = {};

    RARITIES.forEach(r => {
      sessionRarityCounts[r.key] = 0;
      sessionTierCounts[r.key] = { T4: 0, T3: 0, T2: 0, T1: 0 };
    });

    let lastPullCount = 10;

    // --- DOM ELEMENTS ---
    const pullsInput = document.getElementById('pullsInput');
    const totalPullsEl = document.getElementById('totalPulls');
    const totalAncientEl = document.getElementById('totalAncient');
    const sinceAncientEl = document.getElementById('sinceAncient');
    const totalGemsEl = document.getElementById('totalGems');
    const totalMoneyEl = document.getElementById('totalMoney');
    const logEl = document.getElementById('log');
    const sessionReportEl = document.getElementById('sessionReport');

    const runBtn = document.getElementById('runBtn');
    const rerollBtn = document.getElementById('rerollBtn');
    const resetBtn = document.getElementById('resetBtn');

    function appendLog(html) {
      logEl.innerHTML = html;
    }

    function updateStatsUI() {
      totalPullsEl.textContent = totalPulls;
      totalAncientEl.textContent = totalAncientHits;
      sinceAncientEl.textContent = pullsSinceLastAncient;
      totalGemsEl.textContent = totalGems;
      totalMoneyEl.textContent = (totalGems * DOLLAR_PER_GEM).toFixed(2);
    }

    function pickRarity() {
      const roll = Math.random() * TOTAL_RARITY_WEIGHT;
      let acc = 0;
      for (const r of RARITIES) {
        acc += r.prob;
        if (roll < acc) return r;
      }
      return RARITIES[RARITIES.length - 1];
    }

    function pickTier(rarity) {
      const tiers = rarity.tiers;
      const entries = Object.entries(tiers);
      const totalTierWeight = entries.reduce((s, [, p]) => s + p, 0);
      const roll = Math.random() * totalTierWeight;
      let acc = 0;
      for (const [tier, p] of entries) {
        acc += p;
        if (roll < acc) return tier;
      }
      return entries[entries.length - 1][0];
    }

    function pullsForPercentile(p, percentile) {
      if (percentile <= 0 || percentile >= 1) return 0;
      const num = Math.log(1 - percentile);
      const denom = Math.log(1 - p);
      if (denom === 0) return 0;
      return Math.ceil(num / denom);
    }

    function buildSessionReport() {
      const p50Pulls = pullsForPercentile(ANCIENT_P, 0.5);
      const p90Pulls = pullsForPercentile(ANCIENT_P, 0.9);
      const p99Pulls = pullsForPercentile(ANCIENT_P, 0.99);

      const p50Gems = p50Pulls * GEMS_PER_PULL;
      const p90Gems = p90Pulls * GEMS_PER_PULL;
      const p99Gems = p99Pulls * GEMS_PER_PULL;

      const p50CAD = p50Gems * DOLLAR_PER_GEM;
      const p90CAD = p90Gems * DOLLAR_PER_GEM;
      const p99CAD = p99Gems * DOLLAR_PER_GEM;

      let probHit = 0;
      if (totalPulls > 0) {
        probHit = 1 - Math.pow(1 - ANCIENT_P, totalPulls);
      }

      let text = "";
      text += `=== Theoretical Percentiles (0.003% rate) ===\n`;
      text += `50% chance to have hit by : ${p50Pulls.toLocaleString()} pulls (${p50Gems.toLocaleString()} gems, ${p50CAD.toFixed(2)} CAD)\n`;
      text += `90% chance to have hit by : ${p90Pulls.toLocaleString()} pulls (${p90Gems.toLocaleString()} gems, ${p90CAD.toFixed(2)} CAD)\n`;
      text += `99% chance to have hit by : ${p99Pulls.toLocaleString()} pulls (${p99Gems.toLocaleString()} gems, ${p99CAD.toFixed(2)} CAD)\n\n`;

      text += `=== Your Session vs the Odds ===\n`;
      text += `You rolled a total of      : ${totalPulls.toLocaleString()} pulls\n`;
      text += `Your chance to see >=1 hit : ${(probHit * 100).toFixed(2)}%\n`;
      text += `Total successes this run   : ${totalAncientHits}\n\n`;

      if (totalPulls > 0) {
        text += `=== Rarity & Tier Distribution (this session) ===\n`;
        RARITIES.forEach(r => {
          const rCount = sessionRarityCounts[r.key];
          const rPct = (rCount / totalPulls) * 100;
          text += `${r.name} : ${rCount} pulls (${rPct.toFixed(2)}%)\n`;
          const tiers = sessionTierCounts[r.key];
          const tierKeys = ["T4", "T3", "T2", "T1"];
          tierKeys.forEach(tk => {
            if (tiers[tk] && tiers[tk] > 0) {
              const tCount = tiers[tk];
              const tPct = (tCount / totalPulls) * 100;
              text += `  ${tk}: ${tCount} pulls (${tPct.toFixed(2)}%)\n`;
            }
          });
        });
      }

      sessionReportEl.textContent = text;
    }

    function runPullBatch(count) {
      if (count < 0 || count > 3000) {
        appendLog(`Pull count must be between 0 and 3000. You entered: ${count}`);
        return;
      }

      if (count === 0) {
        appendLog(`You did zero pulls this action.\n\nSession totals remain the same.`);
        buildSessionReport();
        return;
      }

      let batchRarityCounts = {};
      let batchTierCounts = {};

      RARITIES.forEach(r => {
        batchRarityCounts[r.key] = 0;
        batchTierCounts[r.key] = { T4: 0, T3: 0, T2: 0, T1: 0 };
      });

      let ancientHitThisBatch = 0;

      for (let i = 0; i < count; i++) {
        const rarity = pickRarity();
        const tier = pickTier(rarity);

        totalPulls++;
        pullsSinceLastAncient++;
        totalGems += GEMS_PER_PULL;

        sessionRarityCounts[rarity.key]++;
        batchRarityCounts[rarity.key]++;

        if (!sessionTierCounts[rarity.key][tier]) {
          sessionTierCounts[rarity.key][tier] = 0;
        }
        if (!batchTierCounts[rarity.key][tier]) {
          batchTierCounts[rarity.key][tier] = 0;
        }

        sessionTierCounts[rarity.key][tier]++;
        batchTierCounts[rarity.key][tier]++;

        if (rarity.key === "ancient") {
          totalAncientHits++;
          ancientHitThisBatch++;
          pullsSinceLastAncient = 0;
        }
      }

      const totalMoney = totalGems * DOLLAR_PER_GEM;

      let msg = "";
      msg += `Pulled: ${count} time(s)\n\n`;
      msg += `Batch results (by rarity & tier):\n`;

      RARITIES.forEach(r => {
        const rCount = batchRarityCounts[r.key];
        if (rCount > 0) {
          msg += `<span class="rarity-${r.key}">- ${r.name}: ${rCount}</span>\n`;
          const tiers = batchTierCounts[r.key];
          const tierOrder = ["T4", "T3", "T2", "T1"];
          tierOrder.forEach(tk => {
            const val = tiers[tk] || 0;
            if (val > 0) {
              msg += `    ${tk}: ${val}\n`;
            }
          });
        }
      });

      if (ancientHitThisBatch > 0) {
        msg += `\n<span class="rarity-ancient">***** ✨ ANCIENT HIT! ✨ *****</span>\n`;
        msg += `You pulled Ancient ${ancientHitThisBatch} time(s) in this batch.\n`;
      } else {
        msg += `\nNo Ancient hit in this batch.\n`;
      }

      msg += `\nSession totals:\n`;
      msg += `  Total pulls: ${totalPulls}\n`;
      msg += `  Total Ancient hits: ${totalAncientHits}\n`;
      msg += `  Pulls since last Ancient: ${pullsSinceLastAncient}\n`;
      msg += `  Total gems spent: ${totalGems}\n`;
      msg += `  Approx money spent: ${totalMoney.toFixed(2)} CAD\n`;

      appendLog(msg);
      updateStatsUI();
      buildSessionReport();
    }

    // --- BUTTON HANDLERS ---
    runBtn.addEventListener('click', () => {
      const pullsVal = parseInt(pullsInput.value, 10);
      if (isNaN(pullsVal)) {
        appendLog('Please enter a valid number of pulls (0–3000).');
        return;
      }
      lastPullCount = pullsVal;
      runPullBatch(pullsVal);
    });

    rerollBtn.addEventListener('click', () => {
      runPullBatch(lastPullCount);
    });

    resetBtn.addEventListener('click', () => {
      totalPulls = 0;
      totalGems = 0;
      totalAncientHits = 0;
      pullsSinceLastAncient = 0;

      RARITIES.forEach(r => {
        sessionRarityCounts[r.key] = 0;
        sessionTierCounts[r.key] = { T4: 0, T3: 0, T2: 0, T1: 0 };
      });

      appendLog('Session reset. Start pulling again!');
      updateStatsUI();
      buildSessionReport();
    });

    // Initialize
    updateStatsUI();
    buildSessionReport();
    appendLog('Ready! Enter how many pulls you want, then click "Run Pulls".');
  </script>
</body>
</html>
